---
title: "Riassunto dei dati sul COVID-19"
output: 
  flexdashboard::flex_dashboard:
    theme: simplex
    orientation: rows
    vertical_layout: scroll
---



```{r echo=FALSE, warning=FALSE, include=FALSE}
rm(list = ls())
require(plotly)
require(tidyverse)
require(sf)
require(flexdashboard)

prefixDir = '~/Documents/lavotex/lavori/covid_19/websites/hugo_universal_new/dati_protezione_civile'

temp = tail(sort(dir(paste(prefixDir,'/data', sep = ''), 'Rdata', full.names = TRUE)),1) ## file 
load(temp)
oggi = max(datiNazionali$data)

load(paste0(prefixDir,'/shapefile_Rformat/region_shape_file.Rdata')) 

## functions definitions ####
filterWeek <- function(x){
  weights = rep(1/7,7)
  y = stats::filter(x, weights, method = 'convolution', side = 1)
  y
}


datiNazionali$nuovi_tamponi = c(datiNazionali$tamponi[1], diff(datiNazionali$tamponi))
datiNazionali$nuovi_testati = c(NA, diff(datiNazionali$casi_testati))
datiNazionali$nuovi_decessi = c(NA, diff(datiNazionali$deceduti))
datiNazionali$nuovi_guariti = c(NA, diff(datiNazionali$dimessi_guariti))

## setting fonts for plotly plots ####
f1 <- list(family = "Arial, sans-serif",
           size = 18,
           color = "lightgrey" )
f2 <- list( family = "Old Standard TT, serif",
            size = 14,
            color = "black" )


## set figure dimension of r chunk
# knitr::opts_chunk$set(fig.width=7)  
# knitr::opts_chunk$set(fig.width=8, fig.height=5.1)  
```

<a href="/blog/">Torna al blog</a>

Nazionale
===================================== 

Row
----------------------------------------
### Andamento nuovi casi e positivi

```{r echo=FALSE}
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = '', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di casi', mirror = 'all', titlefont = f1) 

plyNazNuovi = datiNazionali %>% 
  mutate(nuovi_positivi_smooth = filterWeek(nuovi_positivi), variazione_totale_positivi_smooth = filterWeek(variazione_totale_positivi)) %>% 
  plot_ly(x = ~data, y = ~nuovi_positivi, type = 'scatter', mode = 'line', hovertemplate = paste('<b>Nuovi casi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>','<extra></extra>'), name = 'Nuovi casi', color = I("dodgerblue2")) %>% 
add_lines(x = ~data, y = ~nuovi_positivi_smooth, hovertemplate = paste('<b>Casi smooth</b>','<extra></extra>'), name = "Smooth casi", color = I("dodgerblue2"), line = list(dash = 'dash', width = 1.5)) %>% 
  add_lines(x = ~data, y = ~variazione_totale_positivi, hovertemplate = paste('<b>Variazione positivi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>','<extra></extra>'), name = "Var. positivi", color = I("orange")) %>% 
add_lines(x = ~data, y = ~variazione_totale_positivi_smooth, hovertemplate = paste('<b>Positivi smooth</b>','<extra></extra>'), name = "Smooth positivi", color = I("orange"), line = list(dash = 'dash', width = 1.5)) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x, legend = list(x = .05, y = .95)) 

plyNazNuovi
```

### Decessi e guariti

```{r echo=FALSE, warning=FALSE}
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numerosità', mirror = 'all', titlefont = f1)

plyNazDec = datiNazionali %>%
  plot_ly(x = ~data, y = ~nuovi_decessi, type = 'scatter', mode = 'line', hovertemplate = paste('<b>Nuovi decessi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>','<extra></extra>'), name = 'Nuovi decessi') %>%
  add_lines(x = ~data, y = ~nuovi_guariti, hovertemplate = paste('<b>Dimessi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>','<extra></extra>'), name = "Guariti") %>%
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x, legend = list(x = .05, y = .95))

plyNazDec

```


Row
----------------------------------------

### Decomposizione positivi totali tra ospedalizzati, intensivi e isolati


```{r echo=FALSE}
# ## plot tamponi e positivi  ####
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numerosità', mirror = 'all', titlefont = f1)
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = '', mirror = 'all', tickangle = 45, titlefont = f1)

plyDecPos = plot_ly(data = datiNazionali, x = ~data) %>%
  add_bars(y = ~ricoverati_con_sintomi, name = "Ricoverati", hovertemplate = paste('<b>Ricoverati</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>%
  add_bars(y = ~isolamento_domiciliare, name = 'Isolamento', hovertemplate = paste('<b>Isolamento</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>%
    add_bars(y = ~terapia_intensiva, name = 'Intensiva', hovertemplate = paste('<b>Intensiva</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>%
  layout(xaxis = axis_x,  yaxis = axis_y, barmode = 'stack', legend = list(orientation = 'h'))

plyDecPos
```


### Tamponi



```{r echo=FALSE, warning=FALSE, fig.cap="La linea della serie lisciata è semplicemente una media mobile all'indietro con coefficienti costanti del numero di tamponi o, molto più semplicemente la media dei precedenti sette valori compreso quello del giorno stesso. In questo modo si cerca di togliere la componente periodica connessa al giorno della settimana ed estrapolare l'andamento della serie."}


## plotly graph national data ####
## nuovi casi e variazione positivi
## setting axis
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1) 
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di tamponi effettuati quotidianamente', mirror = 'all', titlefont = f1) 

plyNazTamponi = datiNazionali %>% 
  plot_ly(x = ~data, y = ~nuovi_tamponi, type = 'scatter', mode = 'lines', color = I("dodgerblue2"), hovertemplate = paste('<b>Tamponi quotidiani</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = 'Tamponi del giorno') %>% 
  add_lines(x = ~data, y = ~filterWeek(datiNazionali$nuovi_tamponi), name = "Serie lisciata", color = I("dodgerblue2") , line = list(dash = 'dash', width = 2.0)) %>% 
  add_lines(x = ~data, y = ~nuovi_testati, hovertemplate = paste('<b>Individui testati</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = "Individui testati", color = I("palegreen4")) %>% 
  add_lines(x = ~data, y = ~filterWeek(datiNazionali$nuovi_testati), name = "Serie lisciata", color = I("palegreen4") , line = list(dash = 'dash', width = 2.0)) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x, legend = list(x = .05, y = .95)) 
plyNazTamponi
```

### Nuovi casi rispetto a individui testati
```{r echo = FALSE, warning = FALSE, fig.cap="Nel grafico è rappresentato la serie storica giornaliera della percentuale di nuovi casi rispetto al numero di individui testati, si noti che il denominatore sono i nuovi individui testati e non i tamponi."}

variazioniGiornaliere = datiNazionali %>% transmute(data, nuovi_casi = nuovi_positivi, casi_diagnostici = c(NA, diff(casi_da_sospetto_diagnostico)), casi_screening = c(NA, diff(casi_da_screening)), nuovi_casi_testati = c(NA, diff(casi_testati)), proporzione_diagnostici = casi_diagnostici / nuovi_casi * 100)

## grafico del rapporto tra nuovi casi e numero di individui testati 
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = '% casi rispetto individui testati', mirror = 'all', titlefont = f1)

plyTestatiCasi = variazioniGiornaliere %>% filter(variazioniGiornaliere$data >= "2020-04-21") %>%
  mutate(prop_nuovi_casi = nuovi_casi / nuovi_casi_testati*100) %>% 
  plot_ly(x = ~data, y = ~prop_nuovi_casi, type = 'scatter', mode = 'lines', showlegend = FALSE, name = 'Prop', color = I("dodgerblue2"), hovertemplate = paste('<b>Prop. positivi su testati</b>: %{y}', '<br><b>Data: </b>: %{x}<br>', '<extra></extra>'), line = list(width = 2)) %>%
    add_lines(y = ~filterWeek(prop_nuovi_casi), name = "Prop. lisciata", color = I("red3"), line = list(dash = 'dash', width = 2.0), hovertemplate = paste('serie lisciata', '<extra></extra>')) %>%
  layout(xaxis = axis_x, yaxis = axis_y)
plyTestatiCasi

```





Row
----------------------------------------

### Nuovi casi rispetto al numero di tamponi
```{r echo=FALSE, fig.cap="Nel grafico la linea liscia è il risultato di uno smoothing del grafico fatto con il metodo LOESS (locally estimated scatterplot smoothing). In questo modo si cerca di _estrarre_ la componente regolare dello scatterplot. Per capire come l\'andamento di questa serie sia anche connesso al periodo in cui sono stati effettuati i tamponi si rimanda all'analogo grafico che si trova in questa [pagina](/blog/2020/12/12/covid_naz/index.html#tamponi) in cui con i colori sono mostrate anche le date."}

## nuovi positivi vs tamponi
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Tamponi', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Nuovi casi positivi', mirror = 'all', titlefont = f1)

polyEstimate = loess(data = datiNazionali, nuovi_positivi ~ nuovi_tamponi)
newData = seq(0, max(datiNazionali$nuovi_tamponi), length.out = 200)
previsione = predict(polyEstimate, data.frame(nuovi_tamponi = newData))

markerPers = list(color = ~as.double(data),
                  colorscale = 'Viridis',
                  colorbar = list(
                    title = 'Data',
                    tickvals = round(quantile(as.double(datiNazionali$data), seq(0,.75, by = .25))),
                    ticktext = datiNazionali$data[as.numeric(datiNazionali$data) %in% round(quantile(as.double(datiNazionali$data), seq(0,.75, by = .25)))],
                    tickmode = 'array'
                  )
)

etichette = paste0('<b>Giorno: </b>', datiNazionali$data, '<br><b>Num. testati</b>: ', datiNazionali$nuovi_tamponi, '<br><b>Positivi</b>: ', datiNazionali$nuovi_positivi)

plyTampCases = plot_ly(data = datiNazionali, x = ~newData, y = ~previsione, type = 'scatter', mode = 'lines', showlegend = FALSE, color = I('orange'), name = "Interpolata", hovertemplate = paste('<b>Positivi stimati</b>: %{y}', '<br><b>Tamponi stimati</b>: %{x}<br>')) %>%
   add_trace(x = ~nuovi_tamponi, y = ~nuovi_positivi,  type = 'scatter', mode = 'markers', color = I('lightblue'), text = etichette, hovertemplate = '%{text}', name = '') %>% 
   # add_trace(x = ~nuovi_tamponi, y = ~nuovi_positivi,  type = 'scatter', mode = 'markers', marker = markerPers,  hovertemplate = paste('<b>Num. positivi</b>: %{y}', '<br><b>Tamponi</b>: %{x}<br>'), name = '') %>% 
  layout(xaxis = axis_x, yaxis = axis_y)
plyTampCases
```



### Nuovi casi rispetto a tamponi (solo su soggetti non testati)


```{r echo=FALSE, warning=FALSE, fig.cap="Nel grafico la linea liscia è il risultato di uno smoothing del grafico fatto con il metodo LOESS (locally estimated scatterplot smoothing). In questo modo si cerca di _estrarre_ la componente regolare dello scatterplot."}
## nuovi positivi vs tamponi
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Tamponi a soggetti distinti', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Positivi', mirror = 'all', titlefont = f1)

# temp = datiNazionali[-which.max(datiNazionali$nuovi_testati),]
temp = datiNazionali
temp = temp %>% filter(data >= '2020-04-25')

polyEstimate = loess(data = temp, nuovi_positivi ~ nuovi_testati)
newData = seq(min(temp$nuovi_testati, na.rm = TRUE), max(temp$nuovi_testati, na.rm = TRUE), length.out = 200)
previsione = predict(polyEstimate, data.frame(nuovi_testati = newData))

markerPers = list(color = ~as.double(data),
                  colorscale = 'Viridis',
                  colorbar = list(
                    title = 'Data',
                    tickvals = round(quantile(as.double(datiNazionali$data), seq(0,.75, by = .25))),
                    ticktext = datiNazionali$data[as.numeric(datiNazionali$data) %in% round(quantile(as.double(datiNazionali$data), seq(0,.75, by = .25)))],
                    tickmode = 'array'
                  )
)


etichette = paste0('<b>Giorno: </b>', temp$data, '<br><b>Num. testati</b>: ', temp$nuovi_testati, '<br><b>Positivi</b>: ', temp$nuovi_positivi)

plyTampCases = plot_ly(data = temp, x = ~newData, y = ~previsione, type = 'scatter', mode = 'lines', showlegend = FALSE, color = I('orange'), name = "Interpolata", hovertemplate = paste('<b>Positivi stimati</b>: %{y}', '<br><b>Testati stimati</b>: %{x}<br>')) %>%
   add_trace(x = ~nuovi_testati, y = ~nuovi_positivi,  type = 'scatter', mode = 'markers', color = I('lightblue'), text = etichette, hovertemplate = '%{text}', name = '') %>% 
  layout(xaxis = axis_x, yaxis = axis_y)
plyTampCases

```

### Nuovi casi da attività clinica vs screening

```{r echo=FALSE, warning=FALSE, fig.cap="Nel grafico è rappresentata la decomposizione percentuale dei nuovi casi giornalieri tra positivi da attività clinica (diagnostici) e da attività di screening. Questi dati sono stati messi a disposizione a partire dal 23 luglio 2020."}
## grafico con la decomposizione dei nuovi casi giornalieri in tamponi positivi da attività clinica (diagnostici) o da attività di screening 
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = '', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Percentuale', mirror = 'all', titlefont = f1, range = c(0, 100))

plyDecCasiPerc = variazioniGiornaliere %>% filter(variazioniGiornaliere$data >= "2020-07-23") %>% 
  plot_ly(x = ~data) %>%
  add_bars(y = ~(100 - proporzione_diagnostici), name = "Screening", hovertemplate = paste('<b>Prop. screening</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>%
  add_bars(y = ~proporzione_diagnostici, name = 'Diagnostici', hovertemplate = paste('<b>Prop. diagnosi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>%
  layout(yaxis = axis_y, xaxis = axis_x,  barmode = 'stack', legend = list(orientation = 'h'))
plyDecCasiPerc


```


<!-- Ospedalizzati e decessi {data-navmenu='Nazionale'} -->
<!-- ===================================== -->



```{r include=FALSE}
### load ISTAT shape files ####
load(paste0(prefixDir,'/shapefile_Rformat/counties_shape_file.Rdata')) 
load(paste0(prefixDir,'/demo_data/regioni.Rdata')) 
### load ISTAT demographic data ####

```

Regionale 
=====================================

Row
----------------------------------------

### Totale positivi

```{r tot-pos, echo = FALSE}
## setting axis
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Totale casi', mirror = 'all', titlefont = f1)

plyRegPosAss= datiRegioni %>% group_by(denominazione_regione) %>%
  plot_ly(x = ~data, y = ~totale_positivi, type = 'scatter', mode = 'lines', colors = ~denominazione_regione, hovertemplate = paste('<b>Totale positivi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>%
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x)
plyRegPosAss

```

### Numero casi giornaliero

```{r echo = FALSE}

## setting axis
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Totale positivi', mirror = 'all', titlefont = f1)

plyRegPosAss= datiRegioni %>% group_by(denominazione_regione) %>%
  plot_ly(x = ~data, y = ~nuovi_positivi, type = 'scatter', mode = 'lines', colors = ~denominazione_regione, hovertemplate = paste('<b>Totale positivi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>%
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x)
plyRegPosAss

```


Row
----------------------------------------
### Variazione positivi giornaliero
```{r echo = FALSE}

datiRegioniGrouped = datiRegioni %>% group_by(denominazione_regione)

## setting axis
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Totale casi', mirror = 'all', titlefont = f1)

plyRegPosAss= datiRegioniGrouped %>%
  plot_ly(x = ~data, y = ~variazione_totale_positivi, type = 'scatter', mode = 'lines', colors = ~denominazione_regione, hovertemplate = paste('<b>Variazione positivi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>%
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x)
plyRegPosAss

```


### Numero di casi rispetto alla popolazione

```{r echo = FALSE}
datiRegioni = merge(datiRegioni, demoRegions)
datiRegioni = datiRegioni[order(datiRegioni$data),]

axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di casi ogni 1000 abitanti', mirror = 'all', titlefont = f1)

plyRegCasi= datiRegioni %>% mutate(casiRelativi = totale_casi / popolazione * 1000) %>% group_by(denominazione_regione) %>%
  plot_ly(x = ~data, y = ~casiRelativi, colors = ~denominazione_regione, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Proporzione casi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>%
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x)
plyRegCasi

```


Row
----------------------------------------
### Numero di positivi rispetto alla popolazione

```{r echo = FALSE}
datiRegioni = merge(datiRegioni, demoRegions)
datiRegioni = datiRegioni[order(datiRegioni$data),]

axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di positivi ogni 1000 abitanti', mirror = 'all', titlefont = f1)

plyRegCasi= datiRegioni %>% mutate(positiviRelativi = totale_positivi / popolazione * 1000) %>% group_by(denominazione_regione) %>%
  plot_ly(x = ~data, y = ~positiviRelativi, colors = ~denominazione_regione, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Proporzione positivi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>%
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x)
plyRegCasi

```


<!-- Decessi {data-navmenu='Regionale'} -->
<!-- ======================================== -->

Row
----------------------------------------
### Decessi giornalieri

```{r echo = FALSE, warning=FALSE}
datiRegioni <- datiRegioni %>%
            group_by(denominazione_regione) %>%
            mutate(decessi_giornalieri = c(0, diff(deceduti)))

axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di decessi giornaliero', mirror = 'all', titlefont = f1)

plyRegDecessiGiorn = datiRegioni %>%
  group_by(denominazione_regione) %>%
  plot_ly(x = ~data, y = ~decessi_giornalieri, colors = ~denominazione_regione, type = 'scatter', mode = 'line', hovertemplate = paste('<b>Decessi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>%
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x)
plyRegDecessiGiorn


```


### Decessi rispetto al numero di casi

```{r echo = FALSE, warning=FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di decessi ogni 100 casi', mirror = 'all', titlefont = f1)

plyRegDecessi = datiRegioni %>%
  mutate(decessiRelativi = deceduti / totale_casi * 100) %>%
  group_by(denominazione_regione) %>%
  plot_ly(x = ~data, y = ~decessiRelativi, colors = ~denominazione_regione, type = 'scatter', mode = 'line', hovertemplate = paste('<b>Proporzione decessi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>%
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x)
plyRegDecessi
```


<!-- Tamponi {data-navmenu='Regionale'} -->
<!-- ===================================== -->

Row
----------------------------------------

### Casi testati per regione

```{r echo= FALSE, warning=FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Individui testati ogni 1000 ab.', mirror = 'all', titlefont = f1)

datiRegioni <- datiRegioni %>% group_by(Regione)  %>% mutate(casi_testati_giorn = c(0, diff(casi_testati)))

plyRegTamp= datiRegioni %>% mutate(tasso = casi_testati / popolazione * 1000) %>%
  group_by(denominazione_regione) %>%
  plot_ly(x = ~data, y = ~tasso, colors = ~denominazione_regione, type = 'scatter', mode = 'line', hovertemplate = paste('<b>Ind. testati</b>: %{y:.0f}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>%
  layout(xaxis = axis_x, yaxis = axis_y)
plyRegTamp
```

### Casi testati quotidiani per regione
```{r echo= FALSE, warning=FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Individui testati per giorno', mirror = 'all', titlefont = f1)

plyRegTampQuot = datiRegioni %>% filter(data >= '2020-04-26') %>% 
  group_by(denominazione_regione) %>%
  plot_ly(x = ~data, y = ~casi_testati_giorn, colors = ~denominazione_regione, type = 'scatter', mode = 'line', hovertemplate = paste('<b>Ind. testati giorn.</b>: %{y:.0f}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>%
  layout(xaxis = axis_x, yaxis = axis_y)
plyRegTampQuot


```

Row
----------------------------------------

### Nuovi casi da attività clinica vs screening
Nel grafico è rappresentata la proporzione di nuovi casi che sono stati individuati con test di screening, il complemento a 100 rappresenta la proporzione di casi da attività clinica. Per capire gli andamenti è meglio considerare poche regioni alla volta. Per Marche e Calabria è possibile che i dati non siano affidabili, infatti sono rispettivamente uguali a 0 e a 100 ogni giorno (o quasi).

```{r echo = FALSE, warning= FALSE, fig.cap=""}
## grafico con la decomposizione dei nuovi casi giornalieri in tamponi positivi da attività clinica (diagnostici) o da attività di screening
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = '', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Percentuale', range = list(0,100), mirror = 'all', titlefont = f1)

plyScreening = datiRegioni %>%
  group_by(denominazione_regione) %>%
  mutate(delta_screening = c(0, diff(casi_da_screening)) / nuovi_positivi * 100) %>%
  filter(data >= "2020-07-23") %>%
  plot_ly(x = ~data, y = ~delta_screening, colors = ~denominazione_regione, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Casi da screening</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>%
  layout(yaxis = axis_y, xaxis = axis_x)
plyScreening
```



### Nuovi casi rispetto ad individui testati
```{r echo = FALSE, warning = FALSE}

## grafico del rapporto tra nuovi casi e numero di individui testati
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, range = list(0, 60), showline = T, title = '% casi rispetto individui testati', mirror = 'all', titlefont = f1)

plyTestatiCasiReg = datiRegioniGrouped %>%
  filter(data >= "2020-04-28") %>%
  mutate(nuovi_casi_testati = c(0, diff(casi_testati))) %>%
  plot_ly(x = ~data, y = ~nuovi_positivi / nuovi_casi_testati*100, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Prop. positivi su testati</b>: %{y}', '<br><b>Data: </b>: %{x}<br>'), line = list(width = 1.2), name = ~denominazione_regione) %>%
  layout(xaxis = axis_x, yaxis = axis_y)
plyTestatiCasiReg

```



```{r echo=FALSE, include=FALSE, warning = FALSE}
### load packages ####
library(plotly)
library(sf)
library(DT)
library(tidyverse)

Sys.setenv('MAPBOX_TOKEN' = 'pk.eyJ1IjoiYW5kcmVhLW0iLCJhIjoiY2s4b20zcGFpMDh5cDNldDJ4YTYwNmFlMiJ9.TReLfeIr7ZVEMYMJg2w0-g')


prefixDir = '~/Documents/lavotex/lavori/covid_19/websites/hugo_universal_new/dati_protezione_civile'

## import world shapefile 
load('../../dati_protezione_civile/shapefile_Rformat/all_shapefiles.Rdata')

## LOAD ECDC DATA ----
load('../../dati_protezione_civile/dati_ECDPC/world_data_2020-12-15')
dataOrig = data

# modifiche di formato ad alcune variabili
dataOrig = dataOrig %>% mutate(dateRep = as.Date(dateRep, format = '%d/%m/%Y'), geoId = factor(geoId))

## aggiunge somme di casi cumulate per paese
data = dataOrig %>%  group_by(geoId) %>% arrange(countriesAndTerritories, dateRep) %>% mutate(cumCases = cumsum(cases), cumDeaths = cumsum(deaths))

## elimina entrate "Cases_on_an_international_conveyance_Japan"
data = data %>% filter(countriesAndTerritories != "Cases_on_an_international_conveyance_Japan") %>%
  mutate(countriesAndTerritories = gsub('_', ' ', countriesAndTerritories)) %>%
  mutate(countriesAndTerritories = gsub('United States of America', 'USA', countriesAndTerritories))




############################################################
####                  Europe data                       ####
############################################################


# dataEurope = data %>% filter(geoId %in% europeCodes$Two_Letter_Country_Code)
dataEurope = data %>% filter(countryterritoryCode%in% europeCodes$Three_Letter_Country_Code)


## setting axis
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1)

```


Internazionale
=====================================

Row
----------------------------------------
### Paesi maggiormente colpiti (Casi totali)

In questo grafico è rappresentato l’andamento del numero totale di casi per 15 paesi che hanno avuto il maggior numero di casi in termini assoluti.

```{r echo=FALSE, warning=FALSE}
data = data %>%  mutate(cumCasesRate = cumCases / popData2019 * 1000)

temp = aggregate(data$cumCases, by = list(country = data$countriesAndTerritories), max)
temp = head(temp$country[order(temp$x, decreasing = TRUE)], 15)

temp = data[data$countriesAndTerritories %in% temp,]

axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di casi', mirror = 'all', titlefont = f1)


plyCases = temp %>%
  filter(dateRep >= "2020-02-20") %>% group_by(geoId) %>%
  plot_ly(x = ~dateRep, y = ~cumCases, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Casi: </b>%{y}')) %>%
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Numero di casi', legend = list(x = .05, y = .95))

plyCases
```


### Paesi maggiormente colpiti (Casi per abitante)

Numero di casi per 1000 abitanti nei paesi con il maggior numero assoluto di ammalati.

```{r echo=FALSE, warning=FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di casi per 1000 abitanti', mirror = 'all', titlefont = f1)


plyCasesRate = temp %>%
  filter(dateRep >= "2020-02-20") %>% group_by(geoId) %>%
  plot_ly(x = ~dateRep, y = ~cumCasesRate, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Casi: </b>%{y}')) %>%
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Proporzione di casi rispetto alla popolazione', legend = list(x = .05, y = .95))

plyCasesRate
```


Row
----------------------------------------
### Paesi maggiormente colpiti sulla base del numero di casi per 1000 abitanti

Numero di casi per 1000 abitanti nei paesi con il maggior numero di ammalati ogni 1000 abitanti, in questo caso c'è una preponderanza di paesi piccoli.

```{r echo=FALSE, warning=FALSE}
tempProp = aggregate(data$cumCasesRate, by = list(country = data$countriesAndTerritories), max)
tempProp = head(tempProp$country[order(tempProp$x, decreasing = TRUE)], 15)

tempProp = data[data$countriesAndTerritories %in% tempProp,]

axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, mirror = 'all', titlefont = f1)


plyCasesRate = tempProp %>%
  filter(dateRep >= "2020-02-20") %>% group_by(geoId) %>%
  plot_ly(x = ~dateRep, y = ~cumCasesRate, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Casi: </b>%{y}')) %>%
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Proporzione di casi rispetto alla popolazione', legend = list(x = .05, y = .95))

plyCasesRate
```

### Numero di nuovi casi giornaliero
```{r echo = FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di casi', mirror = 'all', titlefont = f1)


plyCases = temp %>%
  filter(dateRep >= "2020-02-20") %>% group_by(geoId) %>%
  plot_ly(x = ~dateRep, y = ~cases, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Casi: </b>%{y}')) %>%
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Numero di casi', legend = list(x = .05, y = .95))

plyCases
```

<!-- Decessi {data-navmenu='Internazionale' } -->
<!-- ================================================== -->

Row
----------------------------------------
### Numero di decessi rispetto alla popolazione
```{r echo= FALSE}
## proporzione di nuovi decessi rispetto alla popolazione ####
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di nuovi decessi per 100000 abitanti', mirror = 'all', titlefont = f1)

plyNewDeathsRate = temp %>%  mutate(newDeathsRate = deaths / popData2019 * 100000) %>%
  filter(dateRep >= "2020-02-20", popData2019 >= 1.e7) %>% group_by(geoId) %>%
  plot_ly(x = ~dateRep, y = ~newDeathsRate, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Decessi: </b>%{y}')) %>%
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Numero di decessi quotidiani per 100000 abitanti', legend = list(x = .05, y = .95))

plyNewDeathsRate

```

Row
----------------------------------------

### Numero di decessi rispetto al numero di casi
```{r echo=FALSE, warning=FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di decessi su numero di casi', mirror = 'all', titlefont = f1)

plyDeathsCasesRate = temp %>%  mutate(cumDeathsRate = cumDeaths / cumCases * 100) %>%
  filter(dateRep >= "2020-03-02", popData2019 >= 1.e7) %>% group_by(geoId) %>%
  plot_ly(x = ~dateRep, y = ~cumDeathsRate, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Decessi: </b>%{y}')) %>%
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Numero di decessi ogni 100 casi', legend = list(x = .05, y = .95))

plyDeathsCasesRate

```

<!-- Mappe {data-navmenu='Internazionale' } -->
<!-- ========================================= -->

Row
----------------------------------------
### Diffusione in Europa per numero di decessi

```{r map-deaths, echo=FALSE, warning=FALSE}
dataEuropeShp = ungroup(dataEurope %>% filter(dateRep == max(dateRep)))
dataEuropeShp = merge(dataEuropeShp, worldCapital)
tempVars = c("countryterritoryCode", "dateRep","cases","deaths", "popData2019","continentExp","cumCases","cumDeaths","CITY_NAME","CNTRY_NAME","X","Y")
dataEuropeShp = dataEuropeShp[, tempVars]

## add rate of cases
dataEuropeShp = dataEuropeShp %>%
  mutate(cumCasesRate = cumCases/popData2019*1.e4, newCasesRate = cases /popData2019 * 1.e4, cumDeathsRate = cumDeaths/popData2019 *1.e5, newDeathsRate = deaths /popData2019 * 1.e5)

dataEuropeShp = dataEuropeShp %>% filter(CNTRY_NAME != 'San Marino')

europeDeathMap = dataEuropeShp %>% plot_mapbox(height = 600) %>%
  add_markers(x = ~X, y = ~Y, type = 'scatter', mode = 'markers',
              marker = list(color = 'red',
                            # size = ~your_list_of_size_values,
                            size = ~cumDeathsRate,
                            opacity = 0.5,
                            sizemode = 'area',
                            sizeref = .03),
              text = paste('Decessi:', round(dataEuropeShp$cumDeathsRate, 2), '\nStato:', dataEuropeShp$CNTRY_NAME),
              hoverinfo = 'text')  %>%
  layout(mapbox = list(
    center = list(lon = 7.75, lat = 53.58),
    zoom = 3.0),
    showlegend = FALSE,
    title = 'Numero di decessi ogni 100000 abitanti')

europeDeathMap


```

### Diffusione in Europa per numero di casi
```{r echo = FALSE}
europeCasesMap = dataEuropeShp %>% plot_mapbox(height = 600) %>%
  add_markers(x = ~X, y = ~Y, type = 'scatter', mode = 'markers',
              marker = list(color = 'darkgreen',
                            # size = ~your_list_of_size_values,
                            size = ~cumCasesRate,
                            opacity = 0.5,
                            sizemode = 'area',
                            sizeref = .03),
              text = paste('Casi:', round(dataEuropeShp$cumCasesRate, 2), '\nStato:', dataEuropeShp$CNTRY_NAME),
              hoverinfo = 'text')  %>%
  layout(mapbox = list(
    center = list(lon = 7.75, lat = 53.58),
    zoom = 3.0),
    showlegend = FALSE,
    title = 'Numero di casi ogni 10000 abitanti')

europeCasesMap
```

