---
banner: img/banners/covid.png
title: "Riassunto dei dati sul covid-19"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
output: html_document
tags:
- covid
slug: covid_riassunto
---

<style type="text/css">
.main-container {
  max-width: 1500px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{r echo=FALSE, warning=FALSE, include=FALSE}
require(plotly)
require(tidyverse)
require(sf)

prefixDir = '~/Documents/lavotex/lavori/covid_19/websites/hugo_universal_new/dati_protezione_civile'

temp = tail(sort(dir(paste(prefixDir,'/data/', sep = ''), 'Rdata', full.names = TRUE)),1) ## file da caricare
oggi = gsub('_', '-', substr(temp, nchar(temp)-15, nchar(temp)-6))

if (as.Date(oggi)<Sys.Date() ){
source(paste0(prefixDir,'/importazione_dati.R'))
temp = tail(sort(dir(paste(prefixDir,'/data/', sep = ''), 'Rdata', full.names = TRUE)),1) ## file da caricare
}


load(temp)
italyShpRegions <- st_read(paste(prefixDir,'/italy_shape/regioni/Reg01012020_g_WGS84.shp', sep = ''))
# 

## functions definitions ####
filterWeek <- function(x){
  weights = rep(1/7,7)
  y = stats::filter(x, weights, method = 'convolution', side = 1)
  y
}


## set figure dimension of r chunk
knitr::opts_chunk$set(fig.width=7)  
# knitr::opts_chunk$set(fig.width=8, fig.height=5.1)  
```

<a href="/blog/">Torna indietro</a>

## {.tabset}

### Nazionale 

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; grid-auto-flow: row"}


::: {}
#### Tamponi

```{r echo=FALSE}
datiNazionali$nuovi_tamponi = c(datiNazionali$tamponi[1], diff(datiNazionali$tamponi))
datiNazionali$nuovi_testati = c(NA, diff(datiNazionali$casi_testati))
datiNazionali$nuovi_decessi = c(NA, diff(datiNazionali$deceduti))
datiNazionali$nuovi_guariti = c(NA, diff(datiNazionali$dimessi_guariti))

## setting fonts for plotly plots ####
f1 <- list(family = "Arial, sans-serif",
           size = 18,
           color = "lightgrey" )
f2 <- list( family = "Old Standard TT, serif",
            size = 14,
            color = "black" )


## plotly graph national data ####
## nuovi casi e variazione positivi
## setting axis
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1) 
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di tamponi effettuati quotidianamente', mirror = 'all', titlefont = f1) 

plyNazTamponi = datiNazionali %>% 
  plot_ly(x = ~data, y = ~nuovi_tamponi, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Tamponi quotidiani</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = 'Tamponi del giorno') %>% 
  add_lines(x = ~data, y = ~filterWeek(datiNazionali$nuovi_tamponi), name = "Serie lisciata", color = I("dodgerblue2") , line = list(dash = 'dash', width = 3.0)) %>% 
  add_lines(x = ~data, y = ~nuovi_testati, hovertemplate = paste('<b>Individui testati</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = "Individui testati") %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x, legend = list(x = .05, y = .95)) 
plyNazTamponi
```

La linea della serie lisciata è semplicemente una media mobile all'indietro con coefficienti costanti del numero di tamponi o, molto più semplicemente la media dei precedenti sette valori compreso quello del giorno stesso. In questo modo si cerca di togliere la componente periodica connessa al giorno della settimana ed estrapolare l'andamento della serie.


:::

:::{}

#### Nuovi casi rispetto al numero di tamponi
```{r echo=FALSE}
## nuovi positivi vs tamponi
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Tamponi', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Nuovi casi positivi', mirror = 'all', titlefont = f1)

polyEstimate = loess(data = datiNazionali, nuovi_positivi ~ nuovi_tamponi)
newData = seq(0, max(datiNazionali$nuovi_tamponi), length.out = 200)
previsione = predict(polyEstimate, data.frame(nuovi_tamponi = newData))

markerPers = list(color = ~as.double(data),
                  colorscale = 'Viridis',
                  colorbar = list(
                    title = 'Data',
                    tickvals = round(quantile(as.double(datiNazionali$data), seq(0,.75, by = .25))),
                    ticktext = datiNazionali$data[as.numeric(datiNazionali$data) %in% round(quantile(as.double(datiNazionali$data), seq(0,.75, by = .25)))],
                    tickmode = 'array'
                  )
)

etichette = paste0('<b>Giorno: </b>', datiNazionali$data, '<br><b>Num. testati</b>: ', datiNazionali$nuovi_tamponi, '<br><b>Positivi</b>: ', datiNazionali$nuovi_positivi)

plyTampCases = plot_ly(data = datiNazionali, x = ~newData, y = ~previsione, type = 'scatter', mode = 'lines', showlegend = FALSE, color = I('orange'), name = "Interpolata", hovertemplate = paste('<b>Positivi stimati</b>: %{y}', '<br><b>Tamponi stimati</b>: %{x}<br>')) %>%
   add_trace(x = ~nuovi_tamponi, y = ~nuovi_positivi,  type = 'scatter', mode = 'markers', color = I('lightblue'), text = etichette, hovertemplate = '%{text}', name = '') %>% 
   # add_trace(x = ~nuovi_tamponi, y = ~nuovi_positivi,  type = 'scatter', mode = 'markers', marker = markerPers,  hovertemplate = paste('<b>Num. positivi</b>: %{y}', '<br><b>Tamponi</b>: %{x}<br>'), name = '') %>% 
  layout(xaxis = axis_x, yaxis = axis_y)
plyTampCases
```

Nel grafico la linea liscia è il risultato di uno smoothing del grafico fatto con il metodo LOESS (locally estimated scatterplot smoothing). In questo modo si cerca di _estrarre_ la componente regolare dello scatterplot.  
Per capire come l'andamento di questa serie sia anche connesso al periodo in cui sono stati effettuati i tamponi si rimanda all'analogo grafico che si trova in questa [pagina](/blog/2020/covid_naz/index.html#tamponi) in cui con i colori sono mostrate anche le date.

:::



:::{}

#### Nuovi casi rispetto a tamponi (solo su soggetti non testati) 
```{r echo=FALSE, warning=FALSE}
## nuovi positivi vs tamponi
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Tamponi', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Tamponi a soggetti distinti', mirror = 'all', titlefont = f1)

temp = datiNazionali[-which.max(datiNazionali$nuovi_testati),]
polyEstimate = loess(data = temp, nuovi_positivi ~ nuovi_testati)
newData = seq(min(temp$nuovi_testati, na.rm = TRUE), max(temp$nuovi_testati, na.rm = TRUE), length.out = 200)
previsione = predict(polyEstimate, data.frame(nuovi_testati = newData))

markerPers = list(color = ~as.double(data),
                  colorscale = 'Viridis',
                  colorbar = list(
                    title = 'Data',
                    tickvals = round(quantile(as.double(datiNazionali$data), seq(0,.75, by = .25))),
                    ticktext = datiNazionali$data[as.numeric(datiNazionali$data) %in% round(quantile(as.double(datiNazionali$data), seq(0,.75, by = .25)))],
                    tickmode = 'array'
                  )
)


etichette = paste0('<b>Giorno: </b>', temp$data, '<br><b>Num. testati</b>: ', temp$nuovi_testati, '<br><b>Positivi</b>: ', temp$nuovi_positivi)

plyTampCases = plot_ly(data = temp, x = ~newData, y = ~previsione, type = 'scatter', mode = 'lines', showlegend = FALSE, color = I('orange'), name = "Interpolata", hovertemplate = paste('<b>Positivi stimati</b>: %{y}', '<br><b>Testati stimati</b>: %{x}<br>')) %>%
   add_trace(x = ~nuovi_testati, y = ~nuovi_positivi,  type = 'scatter', mode = 'markers', color = I('lightblue'), text = etichette, hovertemplate = '%{text}', name = '') %>% 
  layout(xaxis = axis_x, yaxis = axis_y)
plyTampCases

```

Nel grafico la linea liscia è il risultato di uno smoothing del grafico fatto con il metodo LOESS (locally estimated scatterplot smoothing). In questo modo si cerca di _estrarre_ la componente regolare dello scatterplot.

:::

::: {}

#### Positivi

```{r echo=FALSE}
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = '', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di casi', mirror = 'all', titlefont = f1) 

plyNazNuovi = datiNazionali %>% 
  plot_ly(x = ~data, y = ~nuovi_positivi, type = 'scatter', mode = 'line', hovertemplate = paste('<b>Nuovi infetti</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>','<extra></extra>'), name = 'Nuovi infetti') %>% 
  add_lines(x = ~data, y = ~variazione_totale_positivi, hovertemplate = paste('<b>Saldo positivi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>','<extra></extra>'), name = "Saldo positivi") %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x, legend = list(orientation = 'h')) 

plyNazNuovi

```

I nuovi infetti sono il numero di casi che sono stati osservati in un giorno, mentre il saldo positivi ($saldo_i$) del giorno $i$ è dato da
\[
saldo_{i} = positivi_{i-1} + nuoviCasi_{i} - guariti_{i} - decessi_{i}.
\]

:::

:::{}
#### Nuovi casi rispetto a individui testati
```{r echo = FALSE, warning = FALSE}

variazioniGiornaliere = datiNazionali %>% transmute(data, nuovi_casi = nuovi_positivi, casi_diagnostici = c(NA, diff(casi_da_sospetto_diagnostico)), casi_screening = c(NA, diff(casi_da_screening)), nuovi_casi_testati = c(NA, diff(casi_testati)), proporzione_diagnostici = casi_diagnostici / nuovi_casi * 100)

## grafico del rapporto tra nuovi casi e numero di individui testati 
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = '% casi rispetto individui testati', mirror = 'all', titlefont = f1)

plyTestatiCasi = variazioniGiornaliere %>% filter(variazioniGiornaliere$data >= "2020-04-21") %>% plot_ly(x = ~data, y = ~nuovi_casi / nuovi_casi_testati*100, type = 'scatter', mode = 'lines', showlegend = FALSE, name = '', hovertemplate = paste('<b>Prop. positivi su testati</b>: %{y}', '<br><b>Data: </b>: %{x}<br>'), line = list(width = 3)) %>%
  layout(xaxis = axis_x, yaxis = axis_y)
plyTestatiCasi

```

Nel grafico è rappresentato la serie storica giornaliera della percentuale di nuovi casi rispetto al numero di individui testati, si noti che il denominatore sono i nuovi individui testati e non i tamponi.
:::

:::{}
#### Nuovi casi da attività clinica vs screening
```{r echo = FALSE, warning= FALSE}
## grafico con la decomposizione dei nuovi casi giornalieri in tamponi positivi da attività clinica (diagnostici) o da attività di screening 
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = '', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Percentuale', mirror = 'all', titlefont = f1)

# plyDecCasi = variazioniGiornaliere %>% filter(variazioniGiornaliere$data >= "2020-07-23") %>% 
#   plot_ly(x = ~data) %>%
#   add_bars(y = ~casi_screening, name = "Screening", hovertemplate = paste('<b>Casi da screening</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>%
#   add_bars(y = ~casi_diagnostici, name = 'Diagnostici', hovertemplate = paste('<b>Casi diagnosi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>%
#   layout(title = 'Decomposizione positivi totali', yaxis = axis_y, xaxis = axis_x, barmode = 'stack')
# plyDecCasi

plyDecCasiPerc = variazioniGiornaliere %>% filter(variazioniGiornaliere$data >= "2020-07-23") %>% 
  plot_ly(x = ~data) %>%
  add_bars(y = ~(100 - proporzione_diagnostici), name = "Screening", hovertemplate = paste('<b>Prop. screening</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>%
  add_bars(y = ~proporzione_diagnostici, name = 'Diagnostici', hovertemplate = paste('<b>Prop. diagnosi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>%
  layout(yaxis = axis_y, xaxis = axis_x,  barmode = 'stack', legend = list(orientation = 'h'))
plyDecCasiPerc


```

Nel grafico è rappresentata la decomposizione percentuale dei nuovi casi giornalieri tra positivi da attività clinica (diagnostici) e da attività di screening. Questi dati sono stati messi a disposizione a partire dal 23 luglio 2020.
:::

:::{}

#### Decomposizione positivi totali tra ospedalizzati, intensivi e isolati

```{r echo=FALSE}
# ## plot tamponi e positivi  ####
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numerosità', mirror = 'all', titlefont = f1)
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = '', mirror = 'all', tickangle = 45, titlefont = f1)

plyDecPos = plot_ly(data = datiNazionali, x = ~data) %>%
  add_bars(y = ~ricoverati_con_sintomi, name = "Ricoverati", hovertemplate = paste('<b>Ricoverati</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>%
  add_bars(y = ~isolamento_domiciliare, name = 'Isolamento', hovertemplate = paste('<b>Isolamento</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>%
    add_bars(y = ~terapia_intensiva, name = 'Intensiva', hovertemplate = paste('<b>Intensiva</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>')) %>% 
  layout(xaxis = axis_x,  yaxis = axis_y, barmode = 'stack', legend = list(orientation = 'h'))

plyDecPos
```

:::

:::{}


#### Decessi e guariti

```{r echo=FALSE, warning=FALSE}
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1)
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numerosità', mirror = 'all', titlefont = f1) 

plyNazDec = datiNazionali %>% 
  plot_ly(x = ~data, y = ~nuovi_decessi, type = 'scatter', mode = 'line', hovertemplate = paste('<b>Nuovi decessi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>','<extra></extra>'), name = 'Nuovi decessi') %>% 
  add_lines(x = ~data, y = ~nuovi_guariti, hovertemplate = paste('<b>Dimessi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>','<extra></extra>'), name = "Dimessi") %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x, legend = list(x = .05, y = .95)) 

plyNazDec

```
::: 

::::

### Regionale

```{r include=FALSE}
### ISTAT shape files ####
italyShpRegions <- st_read(paste(prefixDir,'/italy_shape/regioni/Reg01012020_g_WGS84.shp', sep = ''))
italyShpCounties <- st_read(paste(prefixDir,'/italy_shape/province/ProvCM01012020_g_WGS84.shp', sep = ''))



### ISTAT demographic data ####
demoRegions = read.csv(file = paste(prefixDir, '/demo_data/regioni.csv', sep = ''), skip = 1)

demoRegions = demoRegions[demoRegions$Età == 'Totale', c('Regione', 'Totale.Maschi', 'Totale.Femmine')]
rownames(demoRegions) = NULL
demoRegions$popolazione = rowSums(demoRegions[,2:3])
demoRegions$codice_regione = 1:20
demoRegions = demoRegions[, c(5, 1:4)]
```

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; grid-auto-flow: row"}


::: {}
#### Totale positivi

```{r echo = FALSE}
## setting axis
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1) 
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Totale casi', mirror = 'all', titlefont = f1) 

plyRegPosAss= datiRegioni %>% group_by(denominazione_regione) %>% 
  plot_ly(x = ~data, y = ~totale_positivi, type = 'scatter', mode = 'lines', colors = ~denominazione_regione, hovertemplate = paste('<b>Totale positivi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x) 
plyRegPosAss

```



:::

:::{}
#### Numero casi giornaliero
```{r echo = FALSE}

## setting axis
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1) 
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Totale positivi', mirror = 'all', titlefont = f1) 

plyRegPosAss= datiRegioni %>% group_by(denominazione_regione) %>% 
  plot_ly(x = ~data, y = ~nuovi_positivi, type = 'scatter', mode = 'lines', colors = ~denominazione_regione, hovertemplate = paste('<b>Totale positivi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x) 
plyRegPosAss

```


:::

:::{}

#### Variazione positivi giornaliero
```{r echo = FALSE}

datiRegioniGrouped = datiRegioni %>% group_by(denominazione_regione)

## setting axis
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Totale casi', mirror = 'all', titlefont = f1) 

plyRegPosAss= datiRegioniGrouped %>% 
  plot_ly(x = ~data, y = ~variazione_totale_positivi, type = 'scatter', mode = 'lines', colors = ~denominazione_regione, hovertemplate = paste('<b>Variazione positivi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x) 
plyRegPosAss

```


:::

::: {}

#### Numero di casi rispetto alla popolazione

```{r echo = FALSE}
datiRegioni = merge(datiRegioni, demoRegions)
datiRegioni = datiRegioni[order(datiRegioni$data),]

axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di casi ogni 1000 abitanti', mirror = 'all', titlefont = f1) 

plyRegCasi= datiRegioni %>% mutate(casiRelativi = totale_casi / popolazione * 1000) %>% group_by(denominazione_regione) %>% 
  plot_ly(x = ~data, y = ~casiRelativi, colors = ~denominazione_regione, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Proporzione casi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x) 
plyRegCasi

```  

:::

:::{}

#### Numero di positivi rispetto alla popolazione

```{r echo = FALSE}
datiRegioni = merge(datiRegioni, demoRegions)
datiRegioni = datiRegioni[order(datiRegioni$data),]

axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di positivi ogni 1000 abitanti', mirror = 'all', titlefont = f1) 

plyRegCasi= datiRegioni %>% mutate(positiviRelativi = totale_positivi / popolazione * 1000) %>% group_by(denominazione_regione) %>% 
  plot_ly(x = ~data, y = ~positiviRelativi, colors = ~denominazione_regione, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Proporzione positivi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x) 
plyRegCasi

```  

:::

:::{}


#### Decessi

```{r echo = FALSE, warning=FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di decessi totale', mirror = 'all', titlefont = f1) 

plyRegDecessi = datiRegioni %>% 
  group_by(denominazione_regione) %>% 
  plot_ly(x = ~data, y = ~deceduti, colors = ~denominazione_regione, type = 'scatter', mode = 'line', hovertemplate = paste('<b>Proporzione decessi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x) 
plyRegDecessi
```

:::

:::{}


#### Decessi rispetto al numero di casi

```{r echo = FALSE, warning=FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di decessi ogni 100 casi', mirror = 'all', titlefont = f1) 

plyRegDecessi = datiRegioni %>% 
  mutate(decessiRelativi = deceduti / totale_casi * 100) %>% 
  group_by(denominazione_regione) %>% 
  plot_ly(x = ~data, y = ~decessiRelativi, colors = ~denominazione_regione, type = 'scatter', mode = 'line', hovertemplate = paste('<b>Proporzione decessi</b>: %{y}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, xaxis = axis_x) 
plyRegDecessi
```

:::



:::{}
#### Casi testati per regione

```{r echo= FALSE, warning=FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Individui testati ogni 1000 ab.', mirror = 'all', titlefont = f1) 

plyRegTamp= datiRegioni %>% mutate(tasso = casi_testati / popolazione * 1000) %>% 
  group_by(denominazione_regione) %>% 
  plot_ly(x = ~data, y = ~tasso, colors = ~denominazione_regione, type = 'scatter', mode = 'line', hovertemplate = paste('<b>Ind. testati</b>: %{y:.0f}', '<br><b>Giorno</b>: %{x}<br>'), name = ~denominazione_regione) %>% 
  layout(xaxis = axis_x, yaxis = axis_y) 
plyRegTamp
```
:::
::::

### Situazione internazionale

```{r echo=FALSE, include=FALSE}
### load packages ####
library(plotly)
library(sf)
library(DT)
library(tidyverse)

Sys.setenv('MAPBOX_TOKEN' = 'pk.eyJ1IjoiYW5kcmVhLW0iLCJhIjoiY2s4b20zcGFpMDh5cDNldDJ4YTYwNmFlMiJ9.TReLfeIr7ZVEMYMJg2w0-g')


prefixDir = '~/Documents/lavotex/lavori/covid_19/websites/hugo_universal_new/dati_protezione_civile'

########################################
##   Importazione sigle internaz.   ####
##   e suddivisione in continenti   ####
##    INTERNATIONAL STATES CODES    ####
########################################

nationalCode = read_csv(paste0(prefixDir,'/world_shape/country-and-continent-codes-list-csv_csv.csv'))


nationalCode = nationalCode %>% arrange(Continent_Code)
europeCodes = nationalCode %>% filter(Continent_Code == 'EU')


#######################################################
###         Importazione shapefile mondiali         ###
#######################################################

worldMap = st_read(paste0(prefixDir,'/world_shape/CNTR_RG_60M_2016_4326.shp/CNTR_RG_60M_2016_4326.shp'))


## this dataset is from 
## https://hub.arcgis.com/datasets/6996f03a1b364dbab4008d99380370ed_0
worldCities = st_read(paste0(prefixDir, '/world_shape/World_Cities/World_Cities.shp'))
worldCapital = worldCities %>% filter(STATUS %in% c('National capital','National and provincial capital', 'National capital and provincial capital enclave')) %>% 
          mutate(countryterritoryCode = strtrim(GMI_ADMIN, 3))
worldCapital$countryterritoryCode[worldCapital$CNTRY_NAME == 'Montenegro'] = 'MNE'
worldCapital$countryterritoryCode[worldCapital$CNTRY_NAME == 'Romania'] = 'ROU'
worldCapital$countryterritoryCode[worldCapital$CNTRY_NAME == 'Guernsey'] = 'GGY'
worldCapital$countryterritoryCode[worldCapital$CNTRY_NAME == "Isle of Man"] = 'IMN'
worldCapital$countryterritoryCode[worldCapital$CNTRY_NAME == "Jersey"] = 'JEY'

worldCapital = cbind(worldCapital, st_coordinates(worldCapital))              

## these shapefiles are downloaded from 
## https://www.naturalearthdata.com/downloads/
## these are the same of package map
## the following includes sovereign 
# worldStates = st_read('static/dati_protezione_civile/world_shape/ne_10m_admin_0_countries/ne_10m_admin_0_countries.shp')
## the following does NOT include sovereign 
worldStates = st_read(paste0(prefixDir, '/world_shape/ne_10m_admin_0_map_units/ne_10m_admin_0_map_units.shp'))

worldCountries = worldStates %>% filter(TYPE == 'Country')
europeStates = worldStates %>% filter(CONTINENT == "Europe")


#####################################################
####   import datasets from different sources    ####
#####################################################


################################################################
### EUROPEAN CENTRE FOR DISEASE PREVENTION AND CONTROL DATA ####
################################################################
## see https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide
## 
# read the Dataset sheet into “R”. The dataset will be called "data".
dataOrig <- read_csv("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", na = "")

# modifiche di formato ad alcune variabili
dataOrig = dataOrig %>% mutate(dateRep = as.Date(dateRep, format = '%d/%m/%Y'), geoId = factor(geoId))

## aggiunge somme di casi cumulate per paese
data = dataOrig %>%  group_by(geoId) %>% arrange(countriesAndTerritories, dateRep) %>% mutate(cumCases = cumsum(cases), cumDeaths = cumsum(deaths))

## elimina entrate "Cases_on_an_international_conveyance_Japan"
data = data %>% filter(countriesAndTerritories != "Cases_on_an_international_conveyance_Japan") %>% 
  mutate(countriesAndTerritories = gsub('_', ' ', countriesAndTerritories)) %>% 
  mutate(countriesAndTerritories = gsub('United States of America', 'USA', countriesAndTerritories))




############################################################
####                  Europe data                       ####
############################################################


# dataEurope = data %>% filter(geoId %in% europeCodes$Two_Letter_Country_Code) 
dataEurope = data %>% filter(countryterritoryCode%in% europeCodes$Three_Letter_Country_Code) 

### formatting plots ####
f1 <- list(family = "Arial, sans-serif",
           size = 18,
           color = "lightgrey" )
f2 <- list( family = "Old Standard TT, serif",
            size = 14,
            color = "black" )


## setting axis
axis_x <- list(showgrid = T, zeroline = F, nticks = 20, showline = T, title = 'Data', mirror = 'all', tickangle = 45, titlefont = f1)   

## set figure dimension of r chunk
# knitr::opts_chunk$set(fig.width=8)  
# knitr::opts_chunk$set(fig.width=8, fig.height=5.1)  

```

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; grid-auto-flow: row"}

::: {}
#### Paesi maggiormente colpiti (Casi totali)
```{r echo=FALSE, warning=FALSE}
data = data %>%  mutate(cumCasesRate = cumCases / popData2019 * 1000)

temp = aggregate(data$cumCases, by = list(country = data$countriesAndTerritories), max)
temp = head(temp$country[order(temp$x, decreasing = TRUE)], 15)

temp = data[data$countriesAndTerritories %in% temp,]

axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di casi', mirror = 'all', titlefont = f1) 


plyCases = temp %>% 
  filter(dateRep >= "2020-02-20") %>% group_by(geoId) %>% 
  plot_ly(x = ~dateRep, y = ~cumCases, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Casi: </b>%{y}')) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Numero di casi', legend = list(x = .05, y = .95))

plyCases
```
In questo grafico è rappresentato l'andamento del numero totale di casi per 15 paesi che hanno avuto il maggior numero di casi in termini assoluti.
:::


::: {}
#### Paesi maggiormente colpiti (Casi per abitante)
```{r echo=FALSE, warning=FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di casi per 1000 abitanti', mirror = 'all', titlefont = f1) 


plyCasesRate = temp %>% 
  filter(dateRep >= "2020-02-20") %>% group_by(geoId) %>% 
  plot_ly(x = ~dateRep, y = ~cumCasesRate, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Casi: </b>%{y}')) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Proporzione di casi rispetto alla popolazione', legend = list(x = .05, y = .95))

plyCasesRate
```
Numero di casi per 1000 abitanti nei paesi con il maggior numero assoluto di ammalati.
:::

::: {}
#### Paesi maggiormente colpiti sulla base del numero di casi per 1000 abitanti
```{r echo=FALSE, warning=FALSE}
tempProp = aggregate(data$cumCasesRate, by = list(country = data$countriesAndTerritories), max)
tempProp = head(tempProp$country[order(tempProp$x, decreasing = TRUE)], 15)

tempProp = data[data$countriesAndTerritories %in% tempProp,]

axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, mirror = 'all', titlefont = f1) 


plyCasesRate = tempProp %>% 
  filter(dateRep >= "2020-02-20") %>% group_by(geoId) %>% 
  plot_ly(x = ~dateRep, y = ~cumCasesRate, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Casi: </b>%{y}')) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Proporzione di casi rispetto alla popolazione', legend = list(x = .05, y = .95))

plyCasesRate
```
Numero di casi per 1000 abitanti nei paesi con il maggior numero di ammalati ogni 1000 abitanti, in questo caso c'è una preponderanza di paesi piccoli.

:::

::: {}
#### Numero di nuovi casi giornaliero
```{r echo = FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di casi', mirror = 'all', titlefont = f1) 


plyCases = temp %>% 
  filter(dateRep >= "2020-02-20") %>% group_by(geoId) %>% 
  plot_ly(x = ~dateRep, y = ~cases, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Casi: </b>%{y}')) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Numero di casi', legend = list(x = .05, y = .95))

plyCases
```
:::



::: {}
#### Numero di decessi rispetto alla popolazione
```{r echo= FALSE}
## proporzione di nuovi decessi rispetto alla popolazione ####
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di nuovi decessi per 100000 abitanti', mirror = 'all', titlefont = f1) 

plyNewDeathsRate = temp %>%  mutate(newDeathsRate = deaths / popData2019 * 100000) %>% 
  filter(dateRep >= "2020-02-20", popData2019 >= 1.e7) %>% group_by(geoId) %>% 
  plot_ly(x = ~dateRep, y = ~newDeathsRate, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Decessi: </b>%{y}')) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Numero di decessi quotidiani per 100000 abitanti', legend = list(x = .05, y = .95))

plyNewDeathsRate

```

:::

::: {}

#### Numero di decessi rispetto al numero di casi
```{r echo=FALSE, warning=FALSE}
axis_y <- list(showgrid = T, zeroline = F, nticks = 10, showline = T, title = 'Numero di decessi su numero di casi', mirror = 'all', titlefont = f1) 

plyDeathsCasesRate = temp %>%  mutate(cumDeathsRate = cumDeaths / cumCases * 100) %>% 
  filter(dateRep >= "2020-03-02", popData2019 >= 1.e7) %>% group_by(geoId) %>% 
  plot_ly(x = ~dateRep, y = ~cumDeathsRate, name = ~countriesAndTerritories, type = 'scatter', mode = 'lines', hovertemplate = paste('<b>Data: </b>%{x}\n', '<b>Decessi: </b>%{y}')) %>% 
  layout(xaxis = axis_x, yaxis = axis_y, title = 'Numero di decessi ogni 100 casi', legend = list(x = .05, y = .95))

plyDeathsCasesRate

```
:::

:::{}
#### Diffusione in Europa per numero di decessi

```{r map-deaths, echo=FALSE, warning=FALSE}
dataEuropeShp = ungroup(dataEurope %>% filter(dateRep == max(dateRep)))
dataEuropeShp = merge(dataEuropeShp, worldCapital) 
tempVars = c("countryterritoryCode", "dateRep","cases","deaths", "popData2019","continentExp","cumCases","cumDeaths","CITY_NAME","CNTRY_NAME","X","Y") 
dataEuropeShp = dataEuropeShp[, tempVars]

# dataEuropeShp = dataEuropeShp[, c(1, 2, 6, 7, 10, 11, 12, 13, 16, 20, 27, 28)]

## add rate of cases 
dataEuropeShp = dataEuropeShp %>% 
  mutate(cumCasesRate = cumCases/popData2019*1.e4, newCasesRate = cases /popData2019 * 1.e4, cumDeathsRate = cumDeaths/popData2019 *1.e5, newDeathsRate = deaths /popData2019 * 1.e5)

dataEuropeShp = dataEuropeShp %>% filter(CNTRY_NAME != 'San Marino')

europeDeathMap = dataEuropeShp %>% plot_mapbox(height = 600) %>%
  add_markers(x = ~X, y = ~Y, type = 'scatter', mode = 'markers', 
              marker = list(color = 'red',
                            # size = ~your_list_of_size_values,
                            size = ~cumDeathsRate,
                            opacity = 0.5, 
                            sizemode = 'area', 
                            sizeref = .03), 
              text = paste('Decessi:', round(dataEuropeShp$cumDeathsRate, 2), '\nStato:', dataEuropeShp$CNTRY_NAME),
              hoverinfo = 'text')  %>%
  layout(mapbox = list(
    center = list(lon = 7.75, lat = 53.58),
    zoom = 3.0),
    showlegend = FALSE,
    title = 'Numero di decessi ogni 100000 abitanti')

europeDeathMap


```

:::

:::{}
#### Diffusione in Europa per numero di casi
```{r echo = FALSE}
europeCasesMap = dataEuropeShp %>% plot_mapbox(height = 600) %>%
  add_markers(x = ~X, y = ~Y, type = 'scatter', mode = 'markers', 
              marker = list(color = 'darkgreen',
                            # size = ~your_list_of_size_values,
                            size = ~cumCasesRate,
                            opacity = 0.5, 
                            sizemode = 'area', 
                            sizeref = .03), 
              text = paste('Casi:', round(dataEuropeShp$cumCasesRate, 2), '\nStato:', dataEuropeShp$CNTRY_NAME),
              hoverinfo = 'text')  %>%
  layout(mapbox = list(
    center = list(lon = 7.75, lat = 53.58),
    zoom = 3.0),
    showlegend = FALSE,
    title = 'Numero di casi ogni 10000 abitanti')

europeCasesMap
```
:::



::::